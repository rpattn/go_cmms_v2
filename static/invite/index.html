<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Organisation Invite</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { max-width: 560px; padding: 1.25rem 1.5rem; border: 1px solid #ddd; border-radius: 8px; }
    label { display: block; margin-top: 0.75rem; }
    input, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    button { margin-top: 1rem; padding: 0.6rem 1rem; }
    .ok { color: #0a7b25; }
    .err { color: #b00020; }
    .muted { color: #666; font-size: 0.9rem; }
    .token { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f7f7f7; padding: 0.5rem; border-radius: 6px; word-break: break-all; }
  </style>
  <script>
    const API_PREFIX = (() => {
      const m = location.pathname.match(/^(.*)\/invite(?:\/accept)?\/?$/);
      return m ? m[1] : '';
    })();

    async function createInvite(ev) {
      ev.preventDefault();
      const email = document.getElementById('email').value.trim();
      const role = document.getElementById('role').value;
      const out = document.getElementById('output');
      out.textContent = '';
      try {
        const res = await fetch(API_PREFIX + '/auth/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, role })
        });
        const txt = await res.text();
        let data = {};
        try { data = JSON.parse(txt); } catch {}
        if (!res.ok) {
          throw new Error(data.error || txt || ('HTTP ' + res.status));
        }
        document.getElementById('result').style.display = 'block';
        document.getElementById('acceptLink').href = data.accept_url;
        document.getElementById('acceptLink').textContent = data.accept_url;
        document.getElementById('exp').textContent = new Date(data.exp).toLocaleString();
        document.getElementById('role_out').textContent = data.role || role;
        out.className = 'ok';
        out.textContent = 'Invite created. Share the acceptance link below with the recipient.';
      } catch (err) {
        out.className = 'err';
        out.textContent = 'Error: ' + err.message;
      }
    }
    async function copyLink() {
      const a = document.getElementById('acceptLink');
      const t = a.href;
      try { await navigator.clipboard.writeText(t); alert('Link copied'); } catch { alert('Copy failed'); }
    }
  </script>
  <!--
    Notes:
    - This page requires you to be logged in and have Owner role on the active org.
    - The server returns a plaintext token; store only the hash server-side.
    - Deliver token to the recipient out-of-band (email, etc.).
  -->
  </head>
  <body>
    <div class="card">
      <h2>Create Invite</h2>
      <p class="muted">Creates an invite for your current organisation. You must be the Owner. The recipient must log in with the invited email and then accept using the token.</p>
      <form onsubmit="createInvite(event)">
        <label>Email
          <input id="email" type="email" placeholder="user@example.com" required />
        </label>
        <label>Role
          <select id="role">
            <option>Member</option>
            <option>Viewer</option>
            <option>Admin</option>
          </select>
        </label>
        <button type="submit">Create Invite</button>
      </form>
      <p id="output"></p>

      <div id="result" style="display:none; margin-top:1rem;">
        <h3>Acceptance Link</h3>
        <p class="muted">Send this link to the recipient:</p>
        <div><a id="acceptLink" target="_blank" rel="noopener"></a></div>
        <p>Expires: <span id="exp"></span> â€” Role: <span id="role_out"></span></p>
        <button onclick="copyLink()">Copy link</button>
      </div>
    </div>
  </body>
  </html>
