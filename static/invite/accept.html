<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Accept Organisation Invite</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { max-width: 560px; padding: 1.25rem 1.5rem; border: 1px solid #ddd; border-radius: 8px; }
    input { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    button { margin-top: 1rem; padding: 0.6rem 1rem; }
    .ok { color: #0a7b25; }
    .err { color: #b00020; }
    .token { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f7f7f7; padding: 0.5rem; border-radius: 6px; word-break: break-all; }
  </style>
  <script>
    const API_PREFIX = (() => {
      const m = location.pathname.match(/^(.*)\/invite(?:\/accept)?\/?$/);
      return m ? m[1] : '';
    })();

    function init() {
      const params = new URLSearchParams(location.search);
      const t = params.get('token') || '';
      if (t) document.getElementById('token').value = t;
      document.getElementById('pw').disabled = true;
      document.getElementById('setpw').disabled = true;
    }
    async function acceptInvite(ev) {
      ev.preventDefault();
      const token = document.getElementById('token').value.trim();
      const out = document.getElementById('output');
      out.textContent = '';
      try {
        const res = await fetch(API_PREFIX + '/auth/invite/accept', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token })
        });
        const txt = await res.text();
        let data = {};
        try { data = JSON.parse(txt); } catch {}
        if (!res.ok) throw new Error(data.error || txt || ('HTTP ' + res.status));
        out.className = 'ok';
        out.textContent = 'Invite accepted. Set your password below to finish.';
        document.getElementById('pw').disabled = false;
        document.getElementById('setpw').disabled = false;
      } catch (err) {
        out.className = 'err';
        out.textContent = 'Error: ' + err.message;
      }
    }
    async function setPassword(ev) {
      ev.preventDefault();
      const pw = document.getElementById('pw').value;
      const out2 = document.getElementById('output2');
      out2.textContent = '';
      try {
        const res = await fetch(API_PREFIX + '/auth/set-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ password: pw })
        });
        const txt = await res.text();
        let data = {};
        try { data = JSON.parse(txt); } catch {}
        if (!res.ok) throw new Error(data.error || txt || ('HTTP ' + res.status));
        out2.className = 'ok';
        out2.textContent = 'Password set. Redirecting...';
        const dest = (data && data.redirect) ? data.redirect : '/app/work-orders';
        setTimeout(() => { window.location.href = dest; }, 500);
      } catch (err) {
        out2.className = 'err';
        out2.textContent = 'Error: ' + err.message;
      }
    }
  </script>
</head>
<body onload="init()">
  <div class="card">
    <h2>Accept Invite</h2>
    <p>Paste your invite token below and press Accept.</p>
    <form onsubmit="acceptInvite(event)">
      <input id="token" placeholder="paste token here" />
      <button type="submit">Accept</button>
    </form>
    <p id="output"></p>
    <h3>Set Password</h3>
    <form onsubmit="setPassword(event)">
      <input id="pw" type="password" placeholder="new password (min 8 chars)" />
      <button id="setpw" type="submit">Set Password</button>
    </form>
    <p id="output2"></p>
  </div>
</body>
</html>
